#!/usr/bin/env bash

FS_UTILS="$HOME/.bin/utils"
GH_UTILS=https://raw.githubusercontent.com/zenhog/dotfiles/master/bin/utils

function SOURCE() {
  if [[ -r "$FS_UTILS" ]]; then
    source "$FS_UTILS" && return
  fi
  source <(curl -sSL "$GH_UTILS")
}

GITURL=https://github.com/zenhog/dotfiles

BASEDIR="$HOME/.dotfiles"

BRANCHES=(master public private system)

function clone() {

  local dir="${1?}" url="${2?}" branch="${3?}"

  local cmd=(git clone --single-branch --branch="$branch" "$url" "$dir")

  (quiet cd "$dir" || verbose "${cmd[@]}")

  (
    cd "$dir" &&
      if [[ "$(git remote get-url origin)" != "$url" ||
        "$(git branch --show-current)" != "$branch" ]]
      then
        backup "$dir" && verbose "${cmd[@]}"
      fi
  )
}

function init() {
  local branch="${1?}"
  local dir="$BASEDIR/$branch"

  clone "$dir" "$GITURL" "$branch" && decrypt "$branch"
}

function manifest_pull() {
  local branch="${1?}"

  local files

  readarray -t files < <(find "$BASEDIR/$branch" -name 'manifest')

  for f in "${files[@]}"; do
    local dir opts

    read -r dir < <(dirname "$f")

    find "${dir:?}" -exec rm -rf {}/files \;

    opts=(
      --verbose
      --recursive
      --relative
      --links
      --perms
      --no-group
      --no-owner
      --files-from="$f"
      --delete
    )

    if [[ -r "$dir/ignore" ]]; then
      opts+=(--exclude-from="$dir/ignore")
    fi

    verbose sudo rsync "${opts[@]}" / "$dir/files"
    verbose sudo chown -R "$USER:$USER" "$dir/files"
  done
}

function manifest_push() {
  local branch="${1?}"

  local files

  readarray -t files < <(find "$BASEDIR/$branch" -name 'manifest')

  for f in "${files[@]}"; do
    local dir opts

    read -r dir < <(dirname "$f")

    opts=(
      --verbose
      --recursive
      --relative
      --links
      --perms
      --no-group
      --no-owner
      --backup-dir=/.backup
    )

    (cd "$dir" && verbose sudo rsync "${opts[@]}" files/./ /)
  done
}

function stage() {
  local branch="${1?}"

  manifest_pull "$branch" && encrypt "$branch"
  cdgit "$branch" add --all .
}

function sync() {
  local branch="${1?}"

  decrypt "$branch" && manifest_push "$branch"
}

function pull() {
  local branch="${1?}"

  verbose cdgit "$branch" fetch origin "$branch"
  verbose cdgit "$branch" stash
  verbose cdgit "$branch" rebase
  sync "$branch"
  verbose cdgit "$branch" stash pop
}

function push() {
  local branch="${1?}"

  verbose pull "$branch"
  verbose cdgit "$branch" push
}

function update() {
  local branch="${1?}"

  commit "$branch" && push "$branch"
}

function linktarget() {
  local target="$1"
  local link="$2"

  mkdir -p "$(dirname "$link")"

  mute readlink "$link" || backup "$link"

  [[ "$(quiet readlink "$link")" == "$target" ]] && return

  verbose ln -T -svf -- "$target" "$link"
}

function link() {
  local branch="${1?}"

  local hints

  readarray -t hints < <(cd "$BASEDIR/$branch" &&
    find * -name '.linkdir' -or -name '.linkfiles')

  for hint in "${hints[@]}"; do
    local prefix reladir link target dir type

    read -r reladir < <(dirname "$hint")
    read -r _ dir type < <(path "$BASEDIR/$branch/$hint")

    read -r prefix < "$BASEDIR/$branch/$hint"

    case "$type" in
      .linkdir)
        eval "prefix=${prefix:-${HOME}/.}"
        link="${prefix}${reladir}"
        linktarget "$dir" "$link"
        ;;
      .linkfiles)
        eval prefix="${prefix:-${HOME}/.${reladir}/}"

        local files
        readarray -t files < <(cd "$BASEDIR/$branch/$reladir" &&
          find * -type f -or -type l)

        for file in "${files[@]}"; do
          linktarget "$dir/$file" "${prefix}${file}"
        done
        ;;
    esac

  done
}

function install() {
  local branch="${1?}"

  if init "$branch"; then
    manifest_push "$branch" && link "$branch"
  fi
}

function encrypt() {
  local branch="${1?}"
  local dir="$BASEDIR/$branch"

  silent passphrase

  local secrets archives

  readarray -t secrets < <(find "$dir" -name '.gitsecret')

  for secret in "${secrets[@]}"; do
    encsecret "$(dirname "$secret")"
  done

  # remove archives whose associated secret folder was deleted
  readarray -t archives < <(find "$dir" -name '*.tar.gz.gpg')

  for archive in "${archives[@]}"; do
    [[ -f "${archive%.tar.gz.gpg}/.gitsecret" ]] || verbose rm -vf "$archive"
  done
}

function decrypt() {
  local branch="${1?}"
  local dir="$BASEDIR/$branch"

  local archives

  readarray -t archives < <(find "$dir" -name '*.tar.gz.gpg')

  [[ ${#archives[@]} -eq 0 ]] && return

  silent passphrase

  for archive in "${archives[@]}"; do
    (cd "$(dirname "$archive")" && decsecret "$archive")
  done
}

function all() {
  local mod="${1?}"

  for branch in "${BRANCHES[@]}"; do
    verbose "$mod" "$branch" "${@:2}"
  done
}

function cdgit() (
  local branch="${1?}"

  cd "$BASEDIR/$branch" && git "${@:2}"
)

function status() {
  local branch="${1?}"

  stage "$branch" && cdgit "$branch" status
}

function lastdiff() {
  local branch="${1?}"

  cdgit "$branch" diff "$branch"~.."$branch"
}

function diff() {
  local branch="${1?}"

  stage "$branch" && cdgit "$branch" diff "$branch"
}

function commit() {
  local branch="${1?}"

  stage "$branch" &&
    cdgit "$branch" commit -m \
      "autocommit of $(date "+%F") at $(date "+%T") on $(hostname)"
}

function rebranch() (
  local repo="${1?}"
  local branch

  set -e

  read -r branch < <(cdgit "$repo" branch --show-current)

  [[ "$branch" == "$repo" ]]

  verbose cdgit "$repo" checkout --orphan tmp
  commit "$repo"

  verbose cdgit "$repo" branch -D "$branch"
  verbose cdgit "$repo" branch --move tmp "$branch"

  verbose cdgit "$repo" push --set-upstream origin "$branch" --force
)

function cleanup() {
  local branch="${1?}"

  rm -rvf "$BASEDIR/$branch/.git/refs/original"

  cdgit "$branch" reflog expire --expire=now --all
  cdgit "$branch" gc --prune=now
  cdgit "$branch" gc --aggressive --prune=now
}

function mklive() {
  local dir="$HOME/.voidlive"
  local url=https://github.com/void-linux/void-mklive

  [[ -d "$dir" ]] || git clone "$url" "$dir"

  local packages args=(
    console=tty0
    console=ttyS0,115200n8
    net.ifnames=0
    live.user="$USER"
    live.shell=/bin/zsh
    live
  )

  readarray -t packages < <(find /etc/packages/live -type f -exec cat {} \; |
    grep -v -h '^$' | sort -u)

  verbose xbps-install -S --yes --dry-run "${packages[@]}"

  local opts=(
    --verbose
    --recursive
    --relative
    --links
    --perms
  )

  local tmpdir="$(mktemp -d)"

  verbose sudo rsync "${opts[@]}" \
    --exclude=supervise --files-from=/etc/live.manifest \
    "$tmpdir"

  verbose rsync "${opts[@]}" "$HOME/.dotfiles/master" "$tmpdir"

  cd "$dir" && verbose sudo ./mklive.sh -K \
    -C "${args[*]}" \
    -p "${packages[*]}" \
    -T "Custom VoidLinux Live Image" \
    -i gzip -s gzip \
    -I "$tmpdir" \
    -o $HOME/custom-voidlinux-liveimg.iso

  verbose sudo rm -rf "$tmpdir"
}

function checkbin() {
  for bin in "$@"; do
    which "$bin" >/dev/null || return
  done
}

checkbin git gpg curl rsync && mkdir -p "$BASEDIR" && SOURCE && "$@"
