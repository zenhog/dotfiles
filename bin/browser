#!/usr/bin/env bash

LOCKDIR="$HOME/.lockdir"

declare -A SUBPATHS=(
  [whatsapp]='https://web.whatsapp.com/'
  [discord]='https://discord.com/channels/@me'
  [fmovies]='https://ww4.seeflix.to/home/'
  [spotify]='https://open.spotify.com/'
  [youtube]='https://www.youtube.com/'
  [telegram]='https://web.telegram.org/k/'
  [vpn]='https://www.showmyip.com/'
)

setup() {
  local nmh_path="$HOME/.mozilla/native-messaging-hosts"

  local zen_path="$HOME/.local/share/zen"
  local tri_path="$nmh_path/tridactyl.json"
  local vdh_path="$nmh_path/net.downloadhelper.coapp.json"

  local zen_url=(
    'https://github.com/zen-browser/desktop'
    '/releases/latest/download/zen.linux-x86_64.tar.xz'
  )

  local tri_url=(
    'https://raw.githubusercontent.com/tridactyl/native_messenger'
    '/master/installers/install.sh'
  )

  local vdh_url=(
    'https://github.com/aclap-dev/vdhcoapp'
    '/releases/latest/download/install.sh'
  )

  url() (IFS=; printf "%s" "$*")

  read -r zen_url < <(url "${zen_url[@]}")
  read -r tri_url < <(url "${tri_url[@]}")
  read -r vdh_url < <(url "${vdh_url[@]}")

  if [[ ! -d "$zen_path" ]]; then
    if curl -fSL "$zen_url" --output - | tar xJf - -C "${zen_path%/*}"; then
      ln -svf "$zen_path/zen" "$HOME/.local/bin"
    fi
  fi

  if [[ ! -f "$tri_path" ]]; then
    curl -sSLf "$tri_url" | bash
  fi

  if [[ ! -f "$vdh_path" ]]; then
    curl -sSLf "$vdh_url" | bash
  fi
}

clone() (
  local subpath="$1"

  local basedir="$HOME/.zen"

  local basestore="$basedir/wan/storage/default"
  local substore="$basedir/$subpath/storage/default"

  if cd "$basedir"; then
    (
      cd "$substore" &&
      find . -maxdepth 1 -type d -iname '*'"$subpath"'*' \
        -exec rm -rf "$basestore/{}" \; \
        -exec mv -f "$substore/{}" "$basestore" \;
    )

    rm -rf "$subpath"
    cp -a wan "$subpath"

    rm -rf "$subpath/sessionstore-backups/"
  fi
)

spawn() {
  local browser="$1"
  local subpath="$2"
  local profile="$3"
  local lockfile="$LOCKDIR/$profile.lock"

  shift 3

  exec 9>"$lockfile"

  flock -n 9 || exit 1

  if [[ "$subpath" != wan ]]; then
    clone "$subpath"
  fi

  exec "$@"
}

browse() {
  local browser="$1"
  local subpath="$2"

  local profile="$browser.$subpath"

  local url="$3" suburl

  for path in "${!SUBPATHS[@]}"; do
    if [[ "$subpath" == "$path"* ]]; then
      suburl="${SUBPATHS[$path]}"
      break
    fi
  done

  local cmd=(gui awm "${MODE:-bg}" profile="$profile" --)

  cmd+=(browser spawn "$browser" "$subpath" "$profile")

  if [[ "$subpath" == vpn* ]]; then
    cmd+=(cgexec -g net_cls:"$subpath")
  fi

  local subcmd+=("$browser" -p "$subpath")

  if gui awm exists profile="$profile" && [[ -n "$url" ]]; then
    exec "${subcmd[@]}" "$url"
  fi

  if [[ -n "$suburl" ]]; then
    subcmd+=("$suburl")
  fi

  exec "${cmd[@]}" "${subcmd[@]}"
}

main() {
  local browser="$1"
  local subpath="$2"

  shift 2

  read -r CTTY < <(cat /sys/class/tty/tty0/active)
  read -r RTTY < <(cat "/tmp/.X11-unix/registrations/$USER/tty")

  [[ "$CTTY" != "$RTTY" ]] && exec w3m "$@"

  case "$browser" in
    spawn)
      spawn "$subpath" "$@"
      ;;
    zen|firefox)
      setup
      browse "$browser" "$subpath" "$@"
      ;;
    *)
      browser zen wan "$@"
      ;;
  esac
}

main "$@"
