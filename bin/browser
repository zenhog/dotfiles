#!/usr/bin/env bash

TRIDACTYL_URL='https://raw.githubusercontent.com/tridactyl/native_messenger/master/installers/install.sh'

VDHCOAPP_URL='https://github.com/aclap-dev/vdhcoapp/releases/latest/download/install.sh'

ZENBROWSER_URL='https://github.com/zen-browser/desktop/releases/latest/download/zen.linux-x86_64.tar.xz'

TABWRITER_URL='https://raw.githubusercontent.com/snpshtwrx/tabflow/refs/heads/main/native/tabwriter'

NMH_PATH="$HOME/.mozilla/native-messaging-hosts"

TABWRITER_BIN="$HOME/.local/bin/tabwriter"
TABWRITER_PATH="$NMH_PATH/tabwriter.json"
TRIDACTYL_PATH="$NMH_PATH/tridactyl.json"
VDHCOAPP_PATH="$NMH_PATH/net.downloadhelper.coapp.json"
ZENBROWSER_PATH="$HOME/.local/share/zen"

TABWRITER_JSON="$(cat << EOF
{
  "name": "tabwriter",
  "description": "Native app to write open tabs to disk",
  "path": "$HOME/.local/bin/tabwriter",
  "type": "stdio",
  "allowed_extensions": ["@tabflow"]
}
EOF
)"



read -r CTTY < <(cat /sys/class/tty/tty0/active)
read -r RTTY < <(cat "/tmp/.X11-unix/registrations/$USER/tty")

kind="$1"
type="$2"

if [[ "$CTTY" == "$RTTY" ]]; then
  case "$kind" in
    list)
      echo zen
      echo zen-vpn1
      echo zen-vpn2
      echo qutebrowser
      echo qutebrowser-vpn1
      echo qutebrowser-vpn2
      echo firefox
      echo firefox-vpn1
      echo firefox-vpn2
      ;;
    qutebrowser)
      shift

      if [[ "$type" == vpn* ]]; then
        shift
      else
        type=wan
      fi

      tmpdir="/tmp/qutebrowser/instances/$type"

      mkdir -p "$tmpdir/config"

      for f in $HOME/.config/qutebrowser/*; do
        ln -s "$f" "$tmpdir/config/" 2>/dev/null
      done

      mkdir -p "$tmpdir/data/sessions"

      QUTEDATA="$HOME/.local/share/qutebrowser"

      for f in "$QUTEDATA"/sessions/*; do
        ln -s "$f" "$tmpdir/data/sessions/" 2>/dev/null
      done

      for f in "$QUTEDATA"/{blocked-hosts,adblock-cache.dat}; do
        ln -s "$f" "$tmpdir/data/" 2>/dev/null
      done

      profile="$kind-$type"

      [[ "$type" == wan ]] && profile=qutebrowser

      cmd+=(gui awm runonce bg "profile=$profile" --)

      [[ "$type" == vpn* ]] && cmd+=(cgexec -g "net_cls:$type")

      cmd+=(qutebrowser --qt-arg name "$profile" -B "$tmpdir")

      if gui awm exists "profile=$profile"; then
        "${cmd[@]}"
        [[ -n "$*" ]] && qutebrowser -B "$tmpdir" --target tab "$@"
      else
        "${cmd[@]}" --target tab "$@"
      fi
      ;;
    firefox|zen)
      shift

      if [[ "$kind" == zen && ! -d "$ZENBROWSER_PATH" ]]; then
        curl -fSL "$ZENBROWSER_URL" --output - | tar xJf - \
          -C "${ZENBROWSER_PATH%/*}" &&
            ln -svf "$ZENBROWSER_PATH/zen" "$HOME/.local/bin"
      fi

      if [[ ! -r "$TRIDACTYL_PATH" ]]; then
        curl -sSLf "$TRIDACTYL_URL" | bash
      fi

      if [[ ! -r "$VDHCOAPP_PATH" ]]; then
        curl -sSLf "$VDHCOAPP_URL" | bash
      fi

      if [[ ! -x "$TABWRITER_BIN" ]]; then
        curl -fSL "$TABWRITER_URL" --output "$TABWRITER_BIN" &&
          chmod a+x "$TABWRITER_BIN"
      fi

      if [[ ! -r "$TABWRITER_PATH" ]]; then
        echo "$TABWRITER_JSON" > "$TABWRITER_PATH"
      fi

      if [[ "$type" == vpn* ]]; then
        shift
        if ! gui awm exists "profile=$profile"; then
          rm -rf "$HOME/.zen/$type"

          (cd "$HOME/.zen" && git archive zen wan --prefix "$type"/ |
            tar -xf -)
          (cd "$HOME/.zen/$type" && mv wan/* . && rm -rf wan)
        fi
      else
        type=wan
      fi

      profile="$kind-$type"

      [[ "$type" == wan ]] && profile="$kind"

      cmd+=(gui awm runonce bg "profile=$profile" --)

      [[ "$type" == vpn* ]] && cmd+=(cgexec -g "net_cls:$type")

      cmd+=("$kind" -p "$type" --new-instance --class "$profile")

      if gui awm exists "profile=$profile"; then
        "${cmd[@]}"
        [[ -n "$*" ]] && "$kind" -p "$type" --new-tab "$1"
      else
        "${cmd[@]}" "$@"
      fi
      ;;
    *)
      browser zen "$@"
      ;;
  esac
else
  w3m "$@"
fi
