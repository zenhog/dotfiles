#!/usr/bin/env bash

read -r CTTY < <(cat /sys/class/tty/tty0/active)
read -r RTTY < <(cat "/tmp/.X11-unix/registrations/$USER/tty")

kind="$1"
type="$2"

if [[ "$CTTY" == "$RTTY" ]]; then
  case "$kind" in
    qutebrowser)
      case "$type" in
        vpn*)
          tmpdir="/tmp/qutebrowser/instances/$type"

          mkdir -p "$tmpdir/config"

          for f in $HOME/.config/qutebrowser/*; do
            ln -svf "$f" "$tmpdir/config/"
          done

          mkdir -p "$tmpdir/data/sessions"

          for f in $HOME/.local/share/qutebrowser/sessions/*; do
            ln -svf "$f" "$tmpdir/data/sessions/"
          done

          profile="$kind-$type"

          cmd=(
            gui awm runonce fg "profile=$profile" --
            cgexec -g "net_cls:$type"
            qutebrowser --qt-arg name "$profile" -B "$tmpdir"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            [[ -n "${*:3}" ]] && qutebrowser -B "$tmpdir" "${@:3}"
          else
            "${cmd[@]}" "${@:3}"
          fi
          ;;
        *)
          tmpdir="/tmp/qutebrowser/instances/wan"

          mkdir -p "$tmpdir/config"

          for f in $HOME/.config/qutebrowser/*; do
            ln -svf "$f" "$tmpdir/config/"
          done

          mkdir -p "$tmpdir/data/sessions"

          for f in $HOME/.local/share/qutebrowser/sessions/*; do
            ln -svf "$f" "$tmpdir/data/sessions/"
          done

          profile=qutebrowser

          cmd=(
            gui awm runonce fg "profile=$profile" --
            qutebrowser --qt-arg name "$profile" -B "$tmpdir"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            [[ -n "${*:2}" ]] && qutebrowser --target tab "${@:2}"
          else
            "${cmd[@]}" "${@:2}"
          fi
          ;;
      esac
      ;;
    firefox)
      case "$type" in
        vpn*)
          profile="firefox-$type"

          cmd=(
            gui awm runonce fg "profile=$profile" --
            cgexec -g "net_cls:$type"
            firefox -p private --new-instance --class "$profile"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            [[ -n "${*:3}" ]] && firefox -p private "${@:3}"
          else
            "${cmd[@]}" "${@:3}"
          fi
          ;;
        *)
          profile=firefox

          cmd=(
            gui awm runonce fg "profile=$profile" --
            firefox -p private --new-instance --class "$profile"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            [[ -n "${*:2}" ]] && firefox -p private "${@:2}"
          else
            "${cmd[@]}" "${@:2}"
          fi
          ;;
      esac
      ;;
    *)
      browser qutebrowser "$@"
      ;;
  esac
else
  w3m "$@"
fi
