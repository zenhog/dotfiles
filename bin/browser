#!/usr/bin/env bash

read -r CTTY < <(cat /sys/class/tty/tty0/active)
read -r RTTY < <(cat "/tmp/.X11-unix/registrations/$USER/tty")

kind="$1"
type="$2"

shift 2

if [[ "$CTTY" == "$RTTY" ]]; then
  case "$kind" in
    qutebrowser)
      case "$type" in
        wan)
          profile=wanqute

          cmd=(
            gui awm runonce fg "profile=$profile" --
            qutebrowser --qt-arg name wanqute
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            qutebrowser "$@"
          else
            "${cmd[@]}" "$@"
          fi
          ;;
        vpn)
          vpn="$1"

          shift

          tmpdir="/tmp/qutebrowser/instances/$vpn"

          mkdir -p "$tmpdir"

          for f in $HOME/.config/qutebrowser/*; do
            ln -s "$f" "$tmpdir/config/"
          done

          profile="${vpn}qute"

          cmd=(
            gui awm runonce fg "profile=$profile" --
            cgexec -g "net_cls:$vpn"
            qutebrowser --qt-arg name "$profile" -B "$tmpdir"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            qutebrowser -B "$tmpdir" "$@"
          else
            "${cmd[@]}" "$@"
          fi
          ;;
      esac
      ;;
    firefox)
      case "$type" in
        wan)
          profile=wanfox

          cmd=(
            gui awm runonce fg "profile=$profile" --
            firefox -p main --new-instance --class "$profile"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            firefox -p main "$@"
          else
            "${cmd[@]}" "$@"
          fi
          ;;
        vpn)
          vpn="$1"

          shift

          profile="${vpn}fox"

          cmd=(
            gui awm runonce fg "profile=$profile" --
            cgexec -g "net_cls:$vpn"
            firefox -p private --new-instance --class "$profile"
          )

          if gui awm exists "profile=$profile"; then
            "${cmd[@]}"
            firefox -p private "$@"
          else
            "${cmd[@]}" "$@"
          fi
          ;;
      esac
      ;;
    *)
      browser qutebrowser wan "$@"
      ;;
  esac
else
  w3m "$@"
fi
