#!/usr/bin/env bash

shopt -s nullglob

file="$1"
path="$(realpath -s "$file")"

read -r mime < <(file -bL --mime-type "$path")

category="${mime%%/*}"
kind="${mime##*/}"

if [[ "$mime" == inode/directory ]]; then
  if [[ -r "$file/.dirtype" ]]; then
    read -r mime < "$path/.dirtype"
  else
    cd "$file" &&
      exec gui tmux window local "$(hostname)" "$(basename "$path")" "${@:2}"
  fi
fi

case "${mime}" in
  text/*)
    gui tmux window local "$(hostname)" "$(basename "$file")" nvim "$path"
    ;;
  image/*)
    gui awm runonce fg -- nsxiv -a -s f -- "$path"
    ;;
  video/*)
    gui awm runonce fg -- mpv "$path"
    ;;
  application/pdf)
    gui awm runonce fg -- mupdf "$path"
    ;;
  *)
    case "$file" in
      file://*)
        gui tmux window local "$(hostname)" "$(basename "$file")" \
          nvim "${file#file://}"
        ;;
      irc:*)
          ;;
      ircs:*)
          ;;
      mailto:*)
        gui tmux window local "$(hostname)" mail neomutt "${file#mailto:}"
        ;;
      magnet:*)
        gui aria request add "$file"
        ;;
      ftp://*)
        browser "$file"
        ;;
      http://*)
        browser "$file"
        ;;
      https://*)
        browser "$file"
        ;;
      esac
esac
