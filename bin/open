#!/usr/bin/env bash

shopt -s nullglob

file="$1"
path="$(realpath -s "$file")"

read -r mime < <(file -bL --mime-type "$path")

category="${mime%%/*}"
kind="${mime##*/}"

if [[ "$mime" == inode/directory ]]; then
  if [[ -r "$file/.dirtype" ]]; then
    read -r mime < "$path/.dirtype"
  else
    cd "$file" &&
      exec gui tmux window local "$(hostname)" "$(basename "$path")" "${@:2}"
  fi
fi

urlopen() {
  if [[ "$file" == *youtube.com* ]]; then
    browser zen youtube "$file"
  elif [[ "$file" == *whatsapp.com* ]]; then
    browser zen whatsie "$file"
  elif [[ "$file" == *discord.com* ]]; then
    browser zen discord "$file"
  elif [[ "$file" == *seeflix.to* || "$file" == *fastflix.to* ]]; then
    browser zen fmovies "$file"
  elif [[ "$file" == *spotify.com* ]]; then
      browser zen spotify "$file"
  else
    browser "$file"
  fi
}

case "${mime}" in
  text/*)
    gui tmux window local "$(hostname)" "$(basename "$file")" nvim "$path"
    ;;
  image/*)
    gui awm runonce fg -- nsxiv -a -s f -- "$path"
    ;;
  video/*)
    gui awm runonce fg -- mpv "$path"
    ;;
  application/pdf)
    gui awm runonce fg -- mupdf "$path"
    ;;
  *)
    case "$file" in
      file://*)
        gui tmux window local "$(hostname)" "$(basename "$file")" \
          nvim "${file#file://}"
        ;;
      irc:*)
          ;;
      ircs:*)
          ;;
      mailto:*)
        gui tmux window local "$(hostname)" mail neomutt "${file#mailto:}"
        ;;
      magnet:*)
        gui aria request add "$file"
        ;;
      ftp://*)
        browser "$file"
        ;;
      http://*)
        urlopen "$file"
        ;;
      https://*)
        urlopen "$file"
        ;;
      esac
esac
