#!/usr/bin/env bash

KEY=u
MOD='S-M'
ICON=ï‘¡
COLOR=firebrick

HORIZONTAL=1
NOWRAP=1
RATIO=20%

export JS="$HOME/.db/marks.jsonl"

insert() {
  local url="$1"
  local title="$2"

  if [[ "$title" == @* ]]; then
    title="${title#@}"
  else
    read -r url < <(sed -E 's/[#?].*//g' <<<"$url")
    read -r url < <(sed -E 's/\/$//' <<<"$url")
  fi

  local words tags cat mytitle

  read -ra words <<<"$title"

  cat="${words[0]}"

  for word in "${words[@]:1}"; do
    if [[ "$word" == \#* ]]; then
      tags+=("$word")
    else
      mytitle+=("$word")
    fi
  done

  if ! check "$url"; then
    jq -n -c \
      --arg url "$url" \
      --arg title "${mytitle[*]}" \
      --arg cat "$cat" \
      --arg tags "${tags[*]}" \
      '{url: $url, title: $title, cat: $cat, tags: $tags}' >>"$JS"
  else
    local tmp="$(mktemp)"

    jq -c \
      --arg url "$url" \
      --arg title "${mytitle[*]}" \
      --arg cat "$cat" \
      --arg tags "${tags[*]}" \
      'if .url == $url then .title = $title | .cat = $cat | .tags = $tags else . end' "$JS" >"$tmp" &&
      mv "$tmp" "$JS" && rm "$tmp"
  fi
}

view() {
  :
}

ytplaylist() {
  local baseurl="https://www.youtube.com/watch_videos?video_ids="
  local ids

  for url in "$@"; do
    local id

    IFS=$'=' read -r v id <<<"$url"

    ids+=("$id")
  done

  read -r ids < <(
    IFS=,
    printf "%s" "${ids[*]}"
  )

  echo "$baseurl$ids"
}

label() {
  local url
  read -r url _ <<<"$1"
  printf " [%s] " "$url"
}

OPTS=(--with-nth 2.. --header-lines=1 --preview-window=hidden)
list() {

  local lblock rblock

  local C_CAT="$(colorize code magenta)"
  local C_TIT="$(colorize code yellow)"
  local C_TAG="$(colorize code cyan)"
  local C_RESET="$(colorize code reset)"

  IFS= read -r -d '' lblock < <(
    jq -r --arg t "$C_TAG" --arg r "$C_RESET" '.tags | $t + . + $r' "$JS" | column -t
  )

  IFS= read -r -d '' rblock < <(
    jq -r --arg s "$iSEP" --arg u "$C_URL" --arg c "$C_CAT" --arg t "$C_TIT" --arg r "$C_RESET" \
      '.url + $s + (.cat | $c + . + $r) + $s + (.title | $t + . + $r)' "$JS"
  )

  # read -r -d '' rblock < <(jq -r --arg sep "$iSEP" '.url + $sep + .cat + $sep + .title' "$JS" |
  #   column -t -s "$iSEP" -o "$iSEP" -N URL,CATEGORY,TITLE)

  paste -d "$iSEP" <(echo -n "$rblock") <(echo -n "$lblock") | sort |
    column -t -s "$iSEP" -N URL,CATEGORY,TITLE,TAGS
  # echo -n "$rblock"

  # local lines
  #
  # readarray -t lines < <(jq -r --arg sep "$iSEP" '.url + $sep + .cat + $sep + .title + $sep + .tags' "$JS")
  #
  # for line in "${lines[@]}"; do
  #   IFS="$iSEP" read -r url cat title tags <<<"$line"
  #   printfmt "$url" "$cat" "$title" "$tags"
  # done | column -t -s "$iSEP" -N URL,CATEGORY,TITLE,TAGS

}

BINDS[open]=enter
HOOKS[open]=accept
DESCS[open]='Open mark in foreground'

BINDS[bgopen]=tab
HOOKS[bgopen]=noclear
DESCS[bgopen]='Open mark in background'

BINDS[open1]=alt-1
HOOKS[open1]=accept
DESCS[open1]='Open bookmark in cg1'

BINDS[bgopen1]='alt-!'
HOOKS[bgopen1]=accept
DESCS[bgopen1]='Open bookmark in cg1'

BINDS[open2]=alt-2
HOOKS[open2]=accept
DESCS[open2]='Open bookmark in cg2'

BINDS[bgopen2]='alt-@'
HOOKS[bgopen2]=accept
DESCS[bgopen2]='Open bookmark in cg2'

BINDS[open3]=alt-3
HOOKS[open3]=accept
DESCS[open3]='Open bookmark in cg3'

BINDS[bgopen3]='alt-#'
HOOKS[bgopen3]=accept
DESCS[bgopen3]='Open bookmark in cg3'

BINDS[_open]=alt-enter
HOOKS[_open]=clear
DESCS[_open]='Open bookmark with vpnfox'
_open() {
  local url
  read -r url _ <<<"$1"
  urlopen "$url"
}

BINDS[copy]=alt-c
DESCS[copy]='Clipboard bookmark URL'
copy() {
  local url

  read -r url _ <<<"$1"

  tmux load-buffer - <<<"$url"
}

check() {
  local url="$1"

  mute jq -e --arg url "$url" '(select(.url == $url))' "$JS"
}

BINDS[rm]=alt-d
HOOKS[rm]=noclear
DESCS[rm]='Delete bookmark'
rm() {
  local url tmp

  read -r tmp < <(mktemp)

  read -r url _ <<<"$1"

  if check "$url"; then
    grep -vF "\"url\":\"$url\"" "$JS" >"$tmp"
    mv "$tmp" "$JS"
  fi
}

BINDS[mod]=alt-w
HOOKS[mod]=sclear
DESCS[mod]='Rename bookmark'
mod() {
  local url title

  read -r url title <<<"$1"

  read -r title < <(sed -E 's/ +/ /g' <<<"$title")

  # copy the title
  echo -n "$title" | tmux load-buffer -

  # preview
  (
    echo "$title"
    sepline
    list | awk '{print $2}' | sort -u | column -x
  ) | tmux load-buffer -b preview -

  read -r title < <(input preview="'$preview'" label="' [$url] '")

  if [[ -n "$title" ]]; then
    insert "$url" "$title"
  fi
}

add() {
  local url="$1" title="$2" mytitle

  if check "$url"; then
    notify "'$url' already exists"
    return 1
  fi

  (
    echo "$title"
    sepline
    list | awk '{print $2}' | sort -u | column -x
  ) | tmux load-buffer -b preview -

  read -r mytitle < <(menu input label="' [$url] '")

  [[ -z "$mytitle" ]] && return

  [[ "$mytitle" == @ ]] && mytitle="$title"

  insert "$url" "$mytitle"

  if check "$url"; then
    notify "Added '$url'"
  else
    notify "Failed to add '$url'"
  fi
}

del() {
  local url="$1"

  if check "$url"; then
    sqlite3 "$DB" "DELETE FROM bookmarks WHERE url == '$url'"
    if check "$url"; then
      notify "Failed to delete '$url'"
    else
      notify "Deleted '$url'"
    fi
  else
    notify "'$url' does not exist"
  fi
}
