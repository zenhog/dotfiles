#!/usr/bin/env bash

KEY=o
MOD='S-M'
ICON=î¯ˆ

NOWRAP=1

export MUXSOCKET="$HOME/.vmux.S"

function label() {
  local mode="$(get_opt mode)"

  case "$mode" in
    0) mode=sessions ;;
    1) mode=windows ;;
    2) mode=panes ;;
  esac

  echo " mode: $mode "
}

function init() {
  set_opt mode 0
  set_opt mode-mod 3
}

function list() {
  local mode="$(get_opt mode)"

  case "$mode" in
    0) list-sessions ;;
    1) list-windows ;;
    2) list-panes ;;
  esac
}

function list-sessions() {
  local sessions
  readarray -t sessions < <(tmux ls -F '#S')

  for s in "${sessions[@]}"; do
    mute is_remote "$s" && s="$(ansi --yellow "$s")"
    echo "$s"
  done
}

function list-windows() {
  local sid="$1"
  if [[ -n "$sid" ]]; then
    dmux list-windows -t "$sid" -F '#S:#I #W' | column -t
  else
    dmux list-windows -a -F '#S:#I #W' | column -t
  fi
}

function list-panes() {
  local wid="$1"
  if [[ -n "$wid" ]]; then
    dmux list-panes -t "$wid" -F '#S:#I.#P' | column -t
  else
    dmux list-panes -a -F '#S:#I.#P' | column -t
  fi
}

function view() {
  local id mode="$(get_opt mode)"

  read -r id _ <<< "$1"

  case "$mode" in
    0) view-session "$id";;
    1) view-window "$id";;
    2) view-pane "$id";;
  esac
}

function view-session() {
  local ids
  readarray -t ids < <(dmux list-windows -t "$1" -F '#S:#I')
  for id in "${ids[@]}"; do
    view-window "$id"
  done
}

function view-window() {
  local ids
  readarray -t ids < <(dmux list-panes -t "$1" -F '#S:#I.#P')

  for id in "${ids[@]}"; do
    view-pane "$id"
  done
}

function view-pane() {
  ansi --reset-color
  sepline "> $id <"
  dmux capture-pane -t "$1" -pe
}

BINDS[rotate_mode]=alt-t
DESCS[rotate_mode]='Rotate mode'
function rotate_mode() {
  rotate_opt mode
}

COMMANDS+=(mksession)
function mksession() {
  local kind="${1?}"
  local name="${2?}"

  shift 2

  case "$kind" in
    local|menu)
      tmux has-session -t "$name" || tmux new-session -ds "$name"

      tmux has-session -t "$name" || failwith "Failed creating session '$name'"

      set_opt "session-${name}-name" "$name"
      set_opt "session-${name}-kind" "$kind"

      tmux setenv -t "$name" TMUX_SESSION_NAME "$name"
      tmux setenv -t "$name" TMUX_SESSION_KIND "$kind"
      ;;
    remote)
      local port host="$1"

      shift

      if tmux has-session -t "$name"; then
        echo "Remote session '$name' already exists" >&2
        return
      fi

      gui ssh sync "$host" || failwith "Failed to sync host '$host'"

      gui ssh rexec "$host" gui tmux mksession local "$name" ||
        failwith "Failed creating remote session '$name'"

      read -r port < <(gui ssh revport "$host")

      gui ssh rexec "$host" gui tmux set_opt "session-${name}-port" "$port"
      rmux "$host" setenv -t "$name" TMUX_SESSION_PORT "$port"

      tmux new-session -ds "$name" \
        gui ssh ttyexec "$host" tmux attach -t "$name"

      tmux has-session -t "$name" || failwith "Failed creating session '$name'"

      tmux setenv -t "$name" TMUX_SESSION_NAME "$name"
      set_opt "session-${name}-name" "$name"

      tmux setenv -t "$name" TMUX_SESSION_HOST "$host"
      set_opt "session-${name}-host" "$host"

      tmux setenv -t "$name" TMUX_SESSION_KIND "$kind"
      set_opt "session-${name}-kind" "$kind"
      ;;
  esac
}

COMMANDS+=(mkwindow)
function mkwindow() {
  local kind="${1?}"
  local session="${2?}"
  local window="${3?}"

  shift 3

  case "$kind" in
    local|menu)
      attach "$kind" "$session" || return
      tmux new-window -S -n "$window" -t "=${session}:" "$@"
      ;;
    remote)
      local host="${1?}"

      shift

      attach "$kind" "$session" "$host" || return
      rmux "$host" new-window -S -n "$window" -t "=${session}:" "$@"
      ;;
  esac
}

function sync_clipboard() {
  if [[ -n "$DISPLAY" ]]; then
    local tmuxdata=$(tmux show-buffer | base64)
    local xseldata=$(xsel -ob | base64)

    if [[ "$tmuxdata" != "$xseldata" ]]; then
      echo -n "$tmuxdata" | base64 -d | xsel -ib
    fi
  fi
}

function forward_buffer() {
  local name="$(tmux display -p '#S')"
  local kind="$(get_opt "session-${name}-kind")"
  local port="$(get_opt "session-${name}-port")"

  if [[ -n "$port" ]]; then

    local data=$(tmux show-buffer | base64)

    tmux delete-buffer

    exec 3<>"/dev/tcp/localhost/$port"

    echo "$data" >&3

    exec 3>&-
    exec 3<&-

    return
  else
    sync_clipboard
  fi
}

function setup_session() {
  local name="$(tmux display -p '#S')"
  local kind="$(get_opt "session-${name}-kind")"

  case "$kind" in
    menu)
      tmux set status off
      tmux set key-table menu
      ;;
    remote)
      tmux set status off
      ;;
  esac
}

function cleanup_session() {
  local name="$(tmux display -p '#S')"
  local kind="$(get_opt "session-${name}-kind")"

  case "$kind" in
    menu|local)
      unset_opt "session-${name}-name"
      unset_opt "session-${name}-kind"
      ;;
    remote)
      local host="$(get_opt "session-${name}-host")"

      unset_opt "session-${name}-name"
      unset_opt "session-${name}-kind"
      unset_opt "session-${name}-host"

      gui ssh rexec "$host" gui tmux unset_opt "session-${name}-port"
      gui ssh cancel "$host"
      ;;
  esac
}

function is_remote() {
  local sid="$1"

  [[ -z "$sid" ]] && read -r sid < <(tmux display -p '#S')

  [[ -n "$sid" ]] && get_opt "host-$sid"
}

function rmux() {
  local host="$1"

  shift

  gui ssh rexec "$host" tmux "$@"
}

function dmux() {
  local session="$(tmux display -p '#S')"

  [[ -n "$session" ]] || return

  local kind="$(get_opt "session-${session}-kind")"
  local host="$(get_opt "session-${session}-host")"

  if [[ "$kind" == remote ]]; then
    rmux "$host" "$@"
    return
  elif [[ "$kind" == local ]]; then
    tmux "$@"
  fi
}

function on_xsession() {
    local rtty ctty

    read -r ctty < <(cat /sys/class/tty/tty0/active)
    read -r rtty < <(cat "/tmp/.X11-unix/registrations/$USER/tty")

    [[ "$ctty" == "$rtty" ]]
}

function attach() {
  local kind="${1?}"
  local name="${2?}"
  local host="$3"

  local class=tmux

  [[ -n "$host" ]] && class=rmux

  shift

  mksession "$kind" "$name" "$host" ||
    failwith "Failed to create $kind session '$name' on ${host:-localhost}"

  if on_xsession; then
    gui awm runonce fg "instance=$name" -- \
      alacritty --class "$class,$name" --command tmux attach -dxt "$name"

  elif [[ "$TERM" == linux ]] && [[ "$(tty)" == /dev/pts/* ]]; then
    TERM=fbterm tmux attach -dxt "$session"

  elif [[ -n "$TMUX" ]]; then
    tmux switch-client -t "$name" && tmux detach-client -s "$name"
  fi
}

BINDS[open]=enter
HOOKS[open]=accept
DESCS[open]='Run or raise selected tmux session'
function open() {
  function open_session() {
    local name="$1"
    if on_xsession; then

      [[ "$name" == menu ]] && VERB=exec || VERB=run

      awm "$VERB" instance="@$name" -- alacritty --class "tmux,$name" --command \
        tmux new-session -DX -As "$name" "${@:2}"

      until tmux has-session -t "$session"; do
        sleep 0.1
        awm show instance="@$name"
      done
    else
      if [[ -n "$TMUX" ]]; then
        tmux has-session -t "$name" || tmux new-session -ds "$name" "${@:2}"
        tmux switch-client -t "$name"
      else
        if [[ "$TERM" == linux && "$(tty)" =~ /dev/pts/.* ]]; then
          PRE="TERM=fbterm"
        fi
        env "$PRE" tmux new-session -As "$name" "${@:2}"
      fi
    fi
    tmux set-environment -t "$name" TMUX_SESSION_NAME "$name"
  }

  local kind="${1%%:*}"
  local rest="${1#*:}"
  case "$kind" in
    session)
      local session="$rest"
      open_session "$session" "${@:2}"
      ;;
    window) # format: $session_name:$window_number:$window_name
      local window_id="${rest%:*}"
      local window_name="${rest##*:}"
      local session="${rest%%:*}"
      local winflag="${rest#*:}"
      winflag="${winflag%%:*}"

      open_session "$session"
      if [[ "$winflag" == "@" ]]; then
        tmux new-window -S -n "$window_name" -t "=${session}:" "${@:2}"
      else
        tmux select-window -t "$window_id"
      fi
      ;;
  esac
}

BINDS[close]=alt-d
DESCS[close]='Delete selected tmux session'
function close() {
  local kind="${1%%:*}"
  local rest="${1#*:}"
  case "$kind" in
    session)
      tmux kill-session -t "$rest"
      ;;
    window) # format: $session_name:$window_number:$window_name
      local window_id="${rest%:*}"
      local window_name="${rest##*:}"
      local session="${rest%%:*}"
      local winflag="${rest#*:}"
      winflag="${winflag%%:*}"

      tmux kill-window -t "$session:$winflag"
      ;;
  esac
}

function commands() {
  printf "%s\n" "${COMMANDS[@]}"
}
